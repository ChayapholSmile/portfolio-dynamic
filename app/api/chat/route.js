import { dbConnect } from '../../../lib/mongodb'; import ChatMessage from '../../../models/ChatMessage'; import User from '../../../models/User'; import { NextResponse } from 'next/server'; import { getUserFromCookie } from '../../../lib/jwt'; export async function GET(req){ await dbConnect(); const { searchParams } = new URL(req.url); const room = searchParams.get('room') || 'global'; const messages = await ChatMessage.find({ room }).sort({ createdAt:1 }).limit(200); return NextResponse.json({ messages: JSON.parse(JSON.stringify(messages)) }); } export async function POST(req){ await dbConnect(); const me = getUserFromCookie(); const body = await req.json(); const room = body.room || 'global'; let authorName = 'Visitor'; if(me){ const u = await User.findById(me.id); authorName = u?.username || 'User'; } const msg = await ChatMessage.create({ room, author: me?.id, authorName, message: body.message }); return NextResponse.json({ id: msg._id }); }