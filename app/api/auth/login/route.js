import { dbConnect } from '../../../../lib/mongodb'; import User from '../../../../models/User'; import bcrypt from 'bcryptjs'; import { NextResponse } from 'next/server'; import { signJwt } from '../../../../lib/jwt'; export async function POST(req){ await dbConnect(); const { username,password } = await req.json(); const user = await User.findOne({ username }); if(!user) return NextResponse.json({ error:'ไม่พบผู้ใช้' }, { status:401 }); const ok = await bcrypt.compare(password, user.passwordHash); if(!ok) return NextResponse.json({ error:'รหัสผ่านไม่ถูกต้อง' }, { status:401 }); const token = signJwt({ id:user._id.toString(), role:user.role, username:user.username, mustChangePassword:user.mustChangePassword }); const res = NextResponse.json({ ok:true, mustChangePassword: user.mustChangePassword }); res.cookies.set('session', token, { httpOnly:true, secure: process.env.FORCE_HTTPS === 'true', sameSite:'lax', path:'/' }); return res; }