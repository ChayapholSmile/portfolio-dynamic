import { NextResponse } from 'next/server'; import { verify } from 'jsonwebtoken'; const JWT_SECRET = process.env.JWT_SECRET || 'dev-secret'; export function middleware(req){ const url = req.nextUrl.clone(); if(url.pathname.startsWith('/admin')){ const token = req.cookies.get('session')?.value; if(!token){ url.pathname = '/admin/login'; return NextResponse.redirect(url); } try{ const decoded = verify(token, JWT_SECRET); if(decoded?.mustChangePassword && !url.pathname.startsWith('/admin/change-password')){ url.pathname = '/admin/change-password'; return NextResponse.redirect(url); } }catch(e){ url.pathname = '/admin/login'; return NextResponse.redirect(url); } } return NextResponse.next(); } export const config = { matcher: ['/admin/:path*'] };